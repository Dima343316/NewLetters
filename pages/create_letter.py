import streamlit as st
from datetime import datetime
import os
from docx import Document
import openai
from dotenv import load_dotenv

from minions import letter_to_text
from minions import rag_doc
load_dotenv()

# –ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–µ–ª—å—é GPT (–Ω–∞–ø—Ä–∏–º–µ—Ä, Llama)
# –ö–ª–∞—Å—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å API
class LlamaModel:
    def __init__(self):
        self.api_key = os.getenv('OPENAI_TOKEN_API')  # –ß—Ç–µ–Ω–∏–µ –∫–ª—é—á–∞ API
        self.base_url = os.getenv('BASE_OPENAI_URL')
        self.max_input_tokens = 2048  # –ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –≤—Ö–æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        self.max_response_tokens = 2048  # –ú–∞–∫—Å–∏–º—É–º —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –æ—Ç–≤–µ—Ç–∞

    def count_tokens(self, messages):
        tokens = sum(len(message["content"].split()) for message in messages)
        return tokens

    def get_response(self, message):
        messages = [
            {"role": "user", "content": message}
        ]

        total_tokens = self.count_tokens(messages)
        if total_tokens > self.max_input_tokens:
            return "–í–∞—à –≤–æ–ø—Ä–æ—Å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–æ–∫—Ä–∞—Ç–∏—Ç–µ –µ–≥–æ."

        client = openai.Client(
            api_key=self.api_key,
            base_url=self.base_url,
        )


        response=client.chat.completions.create(
                model="openai/gpt-4o-2024-11-20",  # –£–∫–∞–∂–∏—Ç–µ –º–æ–¥–µ–ª—å, –Ω–∞–ø—Ä–∏–º–µ—Ä, OpenAI GPT-3
                messages=messages,
                temperature=0.4,  # –°—Ç–µ–ø–µ–Ω—å —Å–ª—É—á–∞–π–Ω–æ—Å—Ç–∏
                max_tokens=1500,  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
                top_p=0.3,  # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–µ—Ç–æ–¥–∞ nucleus sampling
                frequency_penalty=0.1,  # –®—Ç—Ä–∞—Ñ –∑–∞ —á–∞—Å—Ç–æ—Ç—É
                presence_penalty=0.1,  # –®—Ç—Ä–∞—Ñ –∑–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ
            )

        return response.choices[0].message.content


# –ö–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —à–∞–±–ª–æ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –∑–∞–º–µ–Ω—ã –∑–Ω–∞—á–µ–Ω–∏–π
class PasteValues:
    def __init__(self, template_path, data):
        self.template_path = template_path
        self.data = data

    def change_values(self, letter_body):
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Å —Ç–µ–∫—É—â–µ–π –¥–∞—Ç–æ–π –∏ –≤—Ä–µ–º–µ–Ω–µ–º
        current_datetime = datetime.now().strftime("%Y%m%d-%H%M%S")
        filename = f"docs/result/result_{current_datetime}.docx"

        # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–∞–ø–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞
        os.makedirs(os.path.dirname(filename), exist_ok=True)

        # –û—Ç–∫—Ä—ã–≤–∞–µ–º —à–∞–±–ª–æ–Ω
        doc = Document(self.template_path)

        # –ó–∞–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –≤ –∫–∞–∂–¥–æ–º –ø–∞—Ä–∞–≥—Ä–∞—Ñ–µ
        for p in doc.paragraphs:
            for key, value in self.data.items():
                placeholder = f"${{{key}}}"
                if placeholder in p.text:
                    p.text = p.text.replace(placeholder, value)

        # –í—Å—Ç–∞–≤–ª—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ body –ø–∏—Å—å–º–∞
        for p in doc.paragraphs:
            if "${letter_body}" in p.text:
                p.text = p.text.replace("${letter_body}", letter_body)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
        doc.save(filename)
        return filename


# –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö
def create_letter_page():
    flag_incoming = False
    flag_act = False
    flag_rag = False
    rag_info = ""
    doc_incoming = ""
    st.title("üìÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—Å–µ–º")
    folders = os.listdir(r"db_docs")
    fio_recipient = st.text_input("üîπ –§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è:", placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û...")
    position_recipient = st.text_input("üîπ –î–æ–ª–∂–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–∞—Ç–µ–ª—è:", placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–ª–∂–Ω–æ—Å—Ç—å...")
    laws = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç:", folders)
    comments_for_law = st.text_area("üìù –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∫ –∑–∞–∫–æ–Ω—É:", placeholder="–£–∫–∞–∂–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∫ –∑–∞–∫–æ–Ω—É...")
    if st.button("üìå –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"):
        flag_rag = True
        rag_info = rag_doc.run_gpt_query(comments_for_law, f"db_docs/{laws}")
        st.text_area("–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –ø–∏—Å—å–º–∞", rag_info, height=400)
    comments = st.text_area("üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:", placeholder="–£–∫–∞–∂–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–∏—Å—å–º—É...")
    topic_body = st.text_input("üìù –û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞ –ø–∏—Å—å–º–∞:", placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –ø–∏—Å—å–º–∞...")
    fio_sender = st.text_input("‚úç –§–ò–û –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è:", placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –§–ò–û...")
    doc_date = st.date_input("üìÖ –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:", value=datetime.today())
    if incoming_letter := st.file_uploader("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—Ö–æ–¥—è—â–µ–µ –ø–∏—Å—å–º–æ", type=["pdf", "docx", "txt", "odt"]):
        text_of_doc = letter_to_text.extract_text_from_file(incoming_letter)
    if st.button("üìå –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Ö–æ–¥—è—â–µ–µ –ø–∏—Å—å–º–æ"):
        flag_incoming = True
        llama_model = LlamaModel()
        incoming_gpt = f"""
                    –ò–∑–≤–ª–µ–∫–∏—Ç–µ –∏–∑ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–∏—Å—å–º–∞ —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
                    1. **–ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è**: –ò–º—è —á–µ–ª–æ–≤–µ–∫–∞, –æ—Ç–ø—Ä–∞–≤–∏–≤—à–µ–≥–æ –ø–∏—Å—å–º–æ.
                    2. **–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è**: –ù–∞–∑–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, –æ—Ç –∫–æ—Ç–æ—Ä–æ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–∏—Å—å–º–æ.
                    3. **–î–æ–ª–∂–Ω–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è**: –î–æ–ª–∂–Ω–æ—Å—Ç—å –ª–∏—Ü–∞, –æ—Ç–ø—Ä–∞–≤–∏–≤—à–µ–≥–æ –ø–∏—Å—å–º–æ.
                    4. **–û—Å–Ω–æ–≤–Ω–∞—è —á–∞—Å—Ç—å –ø–∏—Å—å–º–∞**: –°—É—Ç—å –ø–∏—Å—å–º–∞, –∏—Å–∫–ª—é—á–∞—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã.
                    
                    –í–æ—Ç —Ç–µ–∫—Å—Ç –ø–∏—Å—å–º–∞:{text_of_doc}
                    
                    –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏–∑–≤–ª–µ–∫–∏—Ç–µ —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞ –±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑.
    
                        """
        doc_incoming = llama_model.get_response(incoming_gpt)
        st.text_area("–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –≤—Ö–æ–¥—è—â–µ–≥–æ –ø–∏—Å—å–º–∞", doc_incoming, height=400)
    if st.button("üìå –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç"):
        flag_act = True
        llama_model = LlamaModel()
        act_gpt = f"""
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç –∞–∫—Ç–∞ –∏ –≤—ã–¥–µ–ª–∏ –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã. –û–ø—Ä–µ–¥–µ–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–∫—Ç—ã, –≤—ã–≤–æ–¥—ã, —Ä–µ—à–µ–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ—Å—è –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ. –£–∫–∞–∂–∏, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∞–∫–∏–µ-–ª–∏–±–æ –≤–∞–∂–Ω—ã–µ –¥–∞—Ç—ã, –¥–µ–π—Å—Ç–≤–∏—è, —Å—É–±—ä–µ–∫—Ç—ã, –∞ —Ç–∞–∫–∂–µ –ª—é–±—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è—Ö –∏–ª–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π.
            {text_of_doc}
                            """
        doc_incoming = llama_model.get_response(act_gpt)
        st.text_area("–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –∞–∫—Ç–∞", doc_incoming, height=400)
    if st.button("üìå –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–∏—Å—å–º–æ"):
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∏—Å—å–º–∞ —á–µ—Ä–µ–∑ GPT
        llama_model = LlamaModel()
        gpt_input = f"""
                                **!!–°—Ç—Ä–æ–≥–æ!!–ù–µ –≤–∫–ª—é—á–∞–π—Ç–µ –∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ "–° —É–≤–∞–∂–µ–Ω–∏–µ–º" –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–¥–æ–±–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π. **
                                    –°–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ü–∏—Å—å–º–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ –≤ —Å—Ç—Ä–æ–≥–æ–º –¥–µ–ª–æ–≤–æ–º —Å—Ç–∏–ª–µ, –±–µ–∑ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π –∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–π, —Ç–∞–∫–∏—Ö –∫–∞–∫ "–° —É–≤–∞–∂–µ–Ω–∏–µ–º".
                                    –í –ø–∏—Å—å–º–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏–∑–ª–æ–∂–µ–Ω–æ —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–µ–∂–ª–∏–≤—ã—Ö —Ñ—Ä–∞–∑. 
                                    –î–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–º—É –ø–∏—Å—å–º–∞ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
                                    1. **–¢–µ–º–∞ –ø–∏—Å—å–º–∞**: {topic_body}
                                    2. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**: {comments}
                                    –ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏–ª–∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ, —Ç–∏–ø–∞ "–° —É–≤–∞–∂–µ–Ω–∏–µ–º", –∞ —Ç–∞–∫–∂–µ –∏–∑–±–µ–≥–∞–π—Ç–µ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π –∏ –∏–∑–ª–∏—à–Ω–µ–π –≤–µ–∂–ª–∏–≤–æ—Å—Ç–∏.
                                    """
        if rag_info != "":
            gpt_input = f"""
                                    **!!–°—Ç—Ä–æ–≥–æ!!–ù–µ –≤–∫–ª—é—á–∞–π—Ç–µ –∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ "–° —É–≤–∞–∂–µ–Ω–∏–µ–º" –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–¥–æ–±–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π. **
                                        –°–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ü–∏—Å—å–º–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ –≤ —Å—Ç—Ä–æ–≥–æ–º –¥–µ–ª–æ–≤–æ–º —Å—Ç–∏–ª–µ, –±–µ–∑ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π –∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–π, —Ç–∞–∫–∏—Ö –∫–∞–∫ "–° —É–≤–∞–∂–µ–Ω–∏–µ–º".
                                        –í –ø–∏—Å—å–º–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏–∑–ª–æ–∂–µ–Ω–æ —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–µ–∂–ª–∏–≤—ã—Ö —Ñ—Ä–∞–∑.
                                        –î–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–º—É –ø–∏—Å—å–º–∞ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
                                        1. **–¢–µ–∫—Å—Ç –∑–∞–∫–æ–Ω—ã –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤ –ø–∏—Å—å–º–µ**: {rag_info}
                                        2. **–¢–µ–º–∞ –ø–∏—Å—å–º–∞**: {topic_body}
                                        3. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**: {comments}
                                        –ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏–ª–∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ, —Ç–∏–ø–∞ "–° —É–≤–∞–∂–µ–Ω–∏–µ–º", –∞ —Ç–∞–∫–∂–µ –∏–∑–±–µ–≥–∞–π—Ç–µ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π –∏ –∏–∑–ª–∏—à–Ω–µ–π –≤–µ–∂–ª–∏–≤–æ—Å—Ç–∏.
                                    """
        if doc_incoming != "":
            gpt_input = f"""
            **!!–°—Ç—Ä–æ–≥–æ!!–ù–µ –≤–∫–ª—é—á–∞–π—Ç–µ –∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ "–° —É–≤–∞–∂–µ–Ω–∏–µ–º" –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–¥–æ–±–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π. **
                –°–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ü–∏—Å—å–º–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ –≤ —Å—Ç—Ä–æ–≥–æ–º –¥–µ–ª–æ–≤–æ–º —Å—Ç–∏–ª–µ, –±–µ–∑ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π –∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–π, —Ç–∞–∫–∏—Ö –∫–∞–∫ "–° —É–≤–∞–∂–µ–Ω–∏–µ–º".
                –í –ø–∏—Å—å–º–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏–∑–ª–æ–∂–µ–Ω–æ —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–µ–∂–ª–∏–≤—ã—Ö —Ñ—Ä–∞–∑. 
                –î–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–º—É –ø–∏—Å—å–º–∞ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
                –û—Ç–≤–µ—Ç—å –Ω–∞ –≤—Ö–æ–¥—è—â–µ–µ –ø–∏—Å—å–º–æ {doc_incoming}
                1. **–ó–∞–∫–æ–Ω—ã, –ø—Ä–∏–º–µ–Ω—è–µ–º—ã–µ –≤ –ø–∏—Å—å–º–µ**: {laws}
                2. **–¢–µ–º–∞ –ø–∏—Å—å–º–∞**: {topic_body}
                3. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**: {comments}
                –ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏–ª–∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ, —Ç–∏–ø–∞ "–° —É–≤–∞–∂–µ–Ω–∏–µ–º", –∞ —Ç–∞–∫–∂–µ –∏–∑–±–µ–≥–∞–π—Ç–µ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π –∏ –∏–∑–ª–∏—à–Ω–µ–π –≤–µ–∂–ª–∏–≤–æ—Å—Ç–∏.
            """
            flag_incoming = False
        if doc_incoming != "" and rag_info != "":
            gpt_input = f"""
                        **!!–°—Ç—Ä–æ–≥–æ!!–ù–µ –≤–∫–ª—é—á–∞–π—Ç–µ –∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã –≤—Ä–æ–¥–µ "–° —É–≤–∞–∂–µ–Ω–∏–µ–º" –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –ø–æ–¥–æ–±–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π. **
                            –°–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–ª–µ–¥—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö. –ü–∏—Å—å–º–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–æ –≤ —Å—Ç—Ä–æ–≥–æ–º –¥–µ–ª–æ–≤–æ–º —Å—Ç–∏–ª–µ, –±–µ–∑ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π –∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–π, —Ç–∞–∫–∏—Ö –∫–∞–∫ "–° —É–≤–∞–∂–µ–Ω–∏–µ–º".
                            –í –ø–∏—Å—å–º–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –∏–∑–ª–æ–∂–µ–Ω–æ —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–µ–∂–ª–∏–≤—ã—Ö —Ñ—Ä–∞–∑. 
                            –î–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–º—É –ø–∏—Å—å–º–∞ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
                            –û—Ç–≤–µ—Ç—å –Ω–∞ –≤—Ö–æ–¥—è—â–µ–µ –ø–∏—Å—å–º–æ {doc_incoming}
                            1. **–¢–µ–∫—Å—Ç –∑–∞–∫–æ–Ω—ã –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤ –ø–∏—Å—å–º–µ**: {laws}
                            2. **–¢–µ–º–∞ –ø–∏—Å—å–º–∞**: {topic_body}
                            3. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**: {comments}
                            –ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –∏–ª–∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ, —Ç–∏–ø–∞ "–° —É–≤–∞–∂–µ–Ω–∏–µ–º", –∞ —Ç–∞–∫–∂–µ –∏–∑–±–µ–≥–∞–π—Ç–µ —Ñ–æ—Ä–º–∞–ª—å–Ω–æ—Å—Ç–µ–π –∏ –∏–∑–ª–∏—à–Ω–µ–π –≤–µ–∂–ª–∏–≤–æ—Å—Ç–∏.
                        """
        letter_body = llama_model.get_response(gpt_input)

        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ —à–∞–±–ª–æ–Ω
        data = {
            "fio_recipient": fio_recipient,
            "position_recipient": position_recipient,
            "laws": laws,
            "topic_body": topic_body,
            "fio_sender": fio_sender,
            "doc_date": str(doc_date),
            "letter_body": letter_body,
        }

        # –°–æ–∑–¥–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        paste_values = PasteValues("docs/sample/docx_sample.docx", data)
        generated_filename = paste_values.change_values(letter_body)

        # –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
        with open(generated_filename, "rb") as f:
            st.download_button(
                label="–°–∫–∞—á–∞—Ç—å –ø–∏—Å—å–º–æ",
                data=f,
                file_name=generated_filename,
                mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
            )


if __name__ == "__main__":
    create_letter_page()
